services:
  woodpecker:
    image: woodpeckerci/woodpecker-server:v3
    restart: unless-stopped
    volumes:
      - woodpecker-server-data:/var/lib/woodpecker
    environment:
      # ---- Coolify URL magic ----
      # http://woodpecker-xxxxx.example.com -> proxy to port 8000
      - SERVICE_URL_WOODPECKER_8000
      # Woodpecker's external URL (used for OAuth + webhooks)
      - WOODPECKER_HOST=$SERVICE_URL_WOODPECKER_8000

      # ---- Coolify password magic ----
      # Coolify will generate a password and inject as SERVICE_PASSWORD_WOODPECKER
      - SERVICE_SPECIFIC_PASSWORD=${SERVICE_PASSWORD_WOODPECKER}
      # Use that as the shared agent secret
      - WOODPECKER_AGENT_SECRET=${SERVICE_PASSWORD_WOODPECKER}

      # ---- Forgejo / Codeberg integration ----
      # Set these in Coolifyâ€™s env UI:
      # For Codeberg:
      #   WOODPECKER_FORGEJO_URL=https://codeberg.org
      # For self-hosted Forgejo:
      #   WOODPECKER_FORGEJO_URL=https://git.yourdomain.tld
      - WOODPECKER_FORGEJO=true
      - WOODPECKER_FORGEJO_URL=${WOODPECKER_FORGEJO_URL:?}
      - WOODPECKER_FORGEJO_CLIENT=${WOODPECKER_FORGEJO_CLIENT:?}
      - WOODPECKER_FORGEJO_SECRET=${WOODPECKER_FORGEJO_SECRET:?}

      # Optional: open registration / user control
      - WOODPECKER_OPEN=${WOODPECKER_OPEN:-true}

  woodpecker-agent:
    image: woodpeckerci/woodpecker-agent:v3
    restart: unless-stopped
    depends_on:
      - woodpecker
    environment:
      # Connect to gRPC on the server
      - WOODPECKER_SERVER=woodpecker:9000
      # Reuse the same Coolify-generated password
      - WOODPECKER_AGENT_SECRET=${SERVICE_PASSWORD_WOODPECKER}

      # Run builds as Docker containers
      - WOODPECKER_BACKEND=docker
      # If you want to force a specific network:
      # - WOODPECKER_BACKEND_DOCKER_NETWORK=${WOODPECKER_BACKEND_DOCKER_NETWORK:-coolify}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

volumes:
  woodpecker-server-data: